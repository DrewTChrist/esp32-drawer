<!DOCTYPE html>
<html lang="en">

<head>
  <meta name="description" content="Webpage description goes here" />
  <meta charset="utf-8">
  <title>ESP Drawer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="author" content="">
  <link rel="stylesheet" href="css/style.css">
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
</head>


<body>

  <div id="app">
    <div class="container">
      <div class="table-container">
        <div class="key" role="region" aria-label="Instructions, color selection, and grid controls">
          <h2>How to use:</h2>
          <ul>
            <li><span class="key-action">Left-click or drag</span>: Draw</li>
            <li><span class="key-action">Right-click or drag</span>: Erase</li>
          </ul>
          <div class="color-selector">
            <h3>Select color:</h3>
            <div class="color-options">
              <button v-for="color in colors" :key="color" :style="{ backgroundColor: color }"
                :class="{ 'selected': currentColor === color }" @click="setColor(color)"
                :aria-label="`Select ${color} color`"></button>
            </div>
          </div>
          <div class="grid-controls">
            <button @click="clearGrid" class="clear-button" aria-label="Clear entire grid">
              Clear Grid
            </button>
          </div>
        </div>
        <table @mousedown="startDrawing" @mouseup="stopDrawing" @mouseleave="stopDrawing" @contextmenu.prevent>
          <tbody>
            <tr v-for="(row, rIdx) in cellStates" :key="row">
              <td v-for="(col, cIdx) in row" :key="col"
                :style="cellStates[rIdx][cIdx] ? { backgroundColor: cellStates[rIdx][cIdx] } : {}"
                @mouseenter="handleCellHover(rIdx, cIdx, $event)" @mousedown.left.prevent="toggleCell(rIdx, cIdx, true)"
                @mousedown.right.prevent="toggleCell(rIdx, cIdx, false)" role="gridcell"
                :aria-selected="cellStates[rIdx][cIdx] ? 'true' : 'false'"></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</body>
<script>
  const { createApp } = Vue

  createApp({
    data() {
      const hostname = window.location.hostname
      const numCols = 80
      const numRows = 64
      return {
        address: `http://${hostname}:5000`,
        title: `ESP Drawer - (${hostname}:8080)`,
        isDrawing: false,
        isErasing: false,
        numRows,
        numCols,
        chunks: [],
        chunk: [],
        cellStates: Array.from(Array(numRows), () => new Array(numCols).fill(null)),
        colors: ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6'],
        currentColor: '#3b82f6'
      }
    },
    async mounted() {
      document.title = this.title
      var thisRef = this
      await fetch(`${this.address}/data`, {
        method: "GET",
        headers: {},
      }).then(async (data) => {
        const response = await data.json()
        response.coords.forEach(function (coord) {
          thisRef.cellStates[coord[0]][coord[1]] = thisRef.currentColor
        })
      }).catch((error) => {
        console.log(`Error: ${error}`)
      })
    },
    watch: {
      'chunks.length': {
        async handler(newLength, oldLength) {
          if (newLength > oldLength) {
            await this.sendCells()
          }
        },
        deep: true
      }
    },
    methods: {
      async sendCells() {
        const cellsToSend = this.chunks.pop()
        const len = cellsToSend.length
        if (cellsToSend.length < 10) {
          cellsToSend[9] = null
          cellsToSend.fill(null, len, 10)
        }
        if (cellsToSend) {
          await fetch(`${this.address}/data`, {
            method: "POST",
            body: JSON.stringify(cellsToSend),
            headers: {},
          }).then(data => {
            console.log(data)
          }).catch(error => {
            console.log(`Error: ${error}`)
          })
        }
      },
      startDrawing(event) {
        this.isDrawing = true
        this.isErasing = event.button === 2 // Right-click
      },
      stopDrawing() {
        this.isDrawing = false
        this.isErasing = false
        if (this.chunk.length > 0) {
          this.chunks.push(this.chunk)
          this.chunk = []
        }
      },
      toggleCell(row, col, isDrawing) {
        if (!this.cellStates[row][col]) {
          if (this.chunk.length < 10) {
            this.chunk.push([row, col])
          } else {
            this.chunks.push(this.chunk)
            this.chunk = [[row, col]]
          }
        }
        this.cellStates[row][col] = isDrawing ? this.currentColor : null
      },
      handleCellHover(row, col, event) {
        if (this.isDrawing) {
          this.toggleCell(row, col, !this.isErasing)
        }
      },
      setColor(color) {
        this.currentColor = color
      },
      async clearGrid() {
        this.cellStates.forEach(function (row, rowIdx, arr) {
          row.forEach(function (col, colIdx) {
            arr[rowIdx][colIdx] = null;
          })
        })
        await fetch(`${this.address}/clear`, {
          method: "POST",
          headers: {},
        }).then(data => {
          console.log(data)
        }).catch(error => {
          console.log(`Error: ${error}`)
        })
      }
    }
  }).mount('#app')
</script>

</html>
